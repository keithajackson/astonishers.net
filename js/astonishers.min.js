function Page(e,t){var n=this;var r=t;var i=e.type;var s=0;this.id=e.id;this.getLabel=function(){return r};if(i=="photo"){var o=new Array;for(var u=0;u<e.photos.length;u++){o[u]=e.photos[u].original_size.url}this.getElement=function(){var e=document.createElement("div");e.setAttribute("class","contentPage");e.setAttribute("id",n.id);var t=document.createElement("br");for(var r=0;r<o.length;r++){var i=document.createElement("img");i.setAttribute("class","contentPhoto");i.setAttribute("src",o[r]);e.appendChild(i);e.appendChild(t.cloneNode(false))}return e}}else if(i=="video"){var a=e.player[0].embed_code;this.getElement=function(){var e=document.createElement("div");e.setAttribute("class","contentPage");e.setAttribute("id",n.id);e.innerHTML=a;return e}}else{console.log("PAGE: Cannot determine the type of this post!");this.getElement=function(){var e=document.createElement("div");e.setAttribute("class","contentPage");e.setAttribute("id",n.id);return e}}}function TableOfContents(){function s(){console.log("TOC: TOC is loaded!");if(i){$.mobile.loading("hide");i=false}n=true;for(var e=0;e<r.length;e++){r[e]()}r.length=0}function o(e){e=Number(e);console.log("TOC: Attempting to get post count AJAX for chapter "+e);var n;if(e==0){n="prologue"}else{n="chapter "+e}$.ajax({url:"http://api.tumblr.com/v2/blog/astonishers.tumblr.com/posts?callback=?",data:{api_key:"BoJ3Xrg6F6oJA1T5TmK7bn387agH9oAwGV4FoMRBET2rSSYwYK",tag:n},dataType:"jsonp",success:function(r){console.log("TOC: Got "+r.response.total_posts+" pages in "+n);if(r.response.total_posts<=0){console.log("TOC: We are done loading the TOC.  Now running the callback function...");s()}else{t.push(r.response.total_posts);e=Number(e)+1;o(e)}}})}var e=this;var t=new Array;var n=false;var r=new Array;var i=false;this.runWhenLoaded=function(e){if(n){e()}else{console.log("TOC: Waiting for TOC...");r.push(e);if(i==false){i=true;$.mobile.loading("show",{theme:"a",text:"One moment...",textVisible:true})}}};this.isShowingSpinner=function(){return i};this.getChapterCount=function(){return t.length};this.getPageCount=function(e){if(Number(e)<t.length&&Number(e)>=0){return Number(t[Number(e)])}else{return false}};this.hasChapter=function(e){return Number(e)<t.length&&Number(e)>=0};o(t,0,s)}function Book(e,t,n){function a(e,t,n){console.log("BOOK: Attempting to request chapter "+e+" (starting at page index "+t+") via AJAX.");e=Number(e);t=Number(t);var r;if(e==0){r="prologue"}else{r="chapter "+e}$.ajax({url:"http://api.tumblr.com/v2/blog/astonishers.tumblr.com/posts?callback=?",data:{api_key:"BoJ3Xrg6F6oJA1T5TmK7bn387agH9oAwGV4FoMRBET2rSSYwYK",tag:r,offset:t},dataType:"jsonp",success:function(r){var s;if(e==0){s="Prologue"}else{s="Chapter "+e}var o=i.pages.length;for(var u=r.response.posts.length-1;u>=0;u--){var f=s+", Page "+(r.response.posts.length-Number(u));i.pages.push(new Page(r.response.posts[u],f));t++}console.log("BOOK: Chapter "+i.index+" now has "+i.pages.length+" pages.");if(r.response.total_posts-t>0){console.log("BOOK: There are "+(r.response.total_posts-t)+" pages left to load of a total of "+r.response.total_posts+". Getting the next batch...");a(e,t,n)}else{console.log("BOOK: We are done loading the array.  Now running the callback function...");if(n!=null){n()}}}})}function f(e){if(u==false){s.runWhenLoaded(function(){if(s.hasChapter(Number(i.index)+1)){r.jumpTo(Number(i.index)+1,0,false,function(){e(i.pages[i.currentIndex]);return})}else{$.mobile.loading("show",{theme:"a",text:"This is the last page.",textVisible:true,textonly:true});setTimeout(function(){$.mobile.loading("hide")},1e3);e(false);return}})}}function l(e){if(u==false){s.runWhenLoaded(function(){i.index=Number(i.index);console.log("BOOK: Attempting to load previous chapter:"+(i.index-1));if(s.hasChapter(i.index-1)){chNum=i.index-1;pgNum=s.getPageCount(i.index-1)-1;r.jumpTo(chNum,pgNum,false,function(){e(i.pages[i.currentIndex]);return})}else{$.mobile.loading("show",{theme:"a",text:"This is the first page.",textVisible:true,textonly:true});setTimeout(function(){$.mobile.loading("hide")},1e3);e(false);return}})}}var r=this;var i={pages:new Array,index:-1,currentIndex:-1};var s;var o=false;var u=false;this.jumpTo=function(e,t,n,o){u=true;e=Number(e);t=Number(t);if(n==false&&s.isShowingSpinner()==false){$.mobile.loading("show",{theme:"a",text:"One moment...",textVisible:true})}var f=function(f){if(f){if(i.index>=s.getChapterCount()){console.log("BOOK: The chapter ID "+i.index+" is out of range of the toc "+s.getChapterCount());if(s.isShowingSpinner()==false){$.mobile.loading("hide")}u=false;o(false);return}}console.log("BOOK: Attempting to load chapter "+e+", page "+t);if(i.index==e){if(n==false&&s.isShowingSpinner()==false){$.mobile.loading("hide")}u=false;r.getPage(t,o);return}else{i.pages.length=0;t=Number(t);i.index=e;i.currentIndex=t;a(i.index,0,function(){if(n==false&&s.isShowingSpinner()==false){$.mobile.loading("hide")}u=false;o(i.pages[Number(t)]);return})}};if(n){f(false)}else{s.runWhenLoaded(function(){return f(true)})}};this.getPage=function(e,t){e=Number(e);if(e>=i.pages.length){console.log("BOOK: Page out of range of this chapter.");t(false)}else{i.currentIndex=Number(e);t(i.pages[e])}};this.getCurrentPage=function(e){if(i.currentIndex>=i.pages.length||i.currentIndex<0){console.log("BOOK: Page out of range of this chapter.  Returning false.");e(false)}else{e(i.pages[i.currentIndex])}};this.getPreviousPage=function(e){s.runWhenLoaded(function(){if(i.currentIndex-1<0){console.log("BOOK: Previous page out of range of this chapter.");l(e)}else{i.currentIndex--;e(i.pages[i.currentIndex])}})};this.getNextPage=function(e){s.runWhenLoaded(function(){if(i.currentIndex+1>=i.pages.length){console.log("BOOK: Next page out of range of this chapter.");f(e)}else{i.currentIndex++;e(i.pages[i.currentIndex])}})};this.getCurrentChapterIndex=function(){return i.index};this.getCurrentPageIndex=function(){return i.currentIndex};this.loadNavTOC=function(e){s.runWhenLoaded(function(){if(o==false){o=true;$("#dynamicTOC").empty();$("#dynamicTOC").append($("<div>").attr({"data-role":"collapsible-set",id:"toc"}));for(u=0;u<s.getChapterCount();u++){var t="";for(var n=0;n<s.getPageCount(u);n++){console.log("BOOK: Adding a page");t=t+$("<div>").append($("<a>").attr({"data-role":"button",chapterIx:u,pageIx:n}).html("Page "+(Number(n)+1))).html()}var i="Chapter "+u;if(u==0)i="Prologue";$("<div>").attr({"data-role":"collapsible",id:"collapse"+u,"data-content-theme":"a","data-collapsed":"true"}).html("<h4>"+i+"</h4>"+t).appendTo("#toc")}$("#dynamicTOC").collapsibleset().trigger("create");$('#dynamicTOC div a[data-role="button"]').bind("click",function(e){console.log("BOOK: Clicked a generated button!");console.log(this);var t=Number(this.getAttribute("chapterIx"));var n=Number(this.getAttribute("pageix"));console.log("BOOK: Chapter: "+t+", page: "+n);if(typeof t=="number"&&typeof n=="number"){r.jumpTo(t,n,false,displayPage);$("#navPane").popup("close")}return});$("#firstPage").click(function(e){r.jumpTo(0,0,false,displayPage);$("#navPane").popup("close");return});$("#latestPage").click(function(e){var t=s.getChapterCount()-1;var n=s.getPageCount(t)-1;r.jumpTo(t,n,false,displayPage);$("#navPane").popup("close");return})}else{for(var u=0;u<s.getChapterCount();u++){$("#collapse"+u).trigger("collapse").trigger("updatelayout")}}e();return})};r.jumpTo(e,t,true,n);s=new TableOfContents}function getCookie(e){var t=e+"=";var n=document.cookie.split(";");for(var r=0;r<n.length;r++){var i=n[r].trim();if(i.indexOf(t)==0)return i.substring(t.length,i.length)}return""}function setCookie(e,t,n){var r=new Date;r.setTime(r.getTime()+n*24*60*60*1e3);var i="expires="+r.toGMTString();document.cookie=e+"="+t+"; "+i}function displayPage(e){console.log(e);if(e==false)console.log("Failed to load page.");else{$("#mainContent").empty();$("#mainContent").html(e.getElement());window.scrollTo(0,0);$("#pageLabel").html(e.getLabel());setCookie("chapter",astonishers.getCurrentChapterIndex(),30);setCookie("page",astonishers.getCurrentPageIndex(),30)}}var astonishers;$("#previousPage").click(function(e){astonishers.getPreviousPage(displayPage)});$("#nextPage").click(function(e){astonishers.getNextPage(displayPage)});$(document).keydown(function(e){if(e.keyCode==37){astonishers.getPreviousPage(displayPage)}else if(e.keyCode==39){astonishers.getNextPage(displayPage)}});$("#showNavBtn").click(function(e){astonishers.loadNavTOC(function(){$("#navPane").popup("open",{positionTo:"window"})})});$("#contentPane").on("pageinit",function(){var e=getCookie("chapter");var t=getCookie("page");var n=getCookie("suppressSplash");if(e!=""&&!isNaN(e)&&t!=""&&!isNaN(t)){console.log("Loading chapter "+e+", page "+t);astonishers=new Book(e,t,displayPage)}else{console.log("No cookie.  We are starting at the beginning.");astonishers=new Book(0,0,displayPage)}})